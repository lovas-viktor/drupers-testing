language: php
php: 5.6
source_key: "base64_ssh_key_with_github_pantheon_access_here"
env:
  global:
    - PUUID='0759f9d3-f975-4154-a0ec-7a94bd6e73b7'
    - PNAME='drupers-testing'
    - PSOURCE='dev'
    - PEMAIL='viktor.lovas@gmail.com'
    - PPASS='pantheontest'
    - PSITE=$(cat /dev/urandom | tr -cd 'a-z0-9' | head -c 4)
    - PSITE="ci$TRAVIS_BUILD_NUMBER-$PSITE"
    - PHOST="https://$TRAVIS_BRANCH-$PNAME.pantheonsite.io"
install:
  - echo "StrictHostKeyChecking no" > ~/.ssh/config
  - composer global require drush/drush:7.0.0
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - git clone https://github.com/pantheon-systems/terminus.git $HOME/.drush/terminus
  - cd $HOME/.drush/terminus
  - composer update --no-dev
  - drush cc drush
  # Install additional test dependencies here (like Casper, Behat, etc).
before_script:
  - drush pauth $PEMAIL --password=$PPASS
  - cd $TRAVIS_BUILD_DIR
  - git checkout -b $PSITE
  - git remote add pantheon ssh://codeserver.dev.$PUUID@codeserver.dev.$PUUID.drush.in:2222/~/repository.git
  - git push --force pantheon $PSITE
  - drush psite-ecreate $PUUID $PSITE --source=$PSOURCE || true
  - drush paliases
  - drush cc drush
  - cd $HOME
  - drush @pantheon.$PNAME.$PSITE updb -y --strict=0
  - drush @pantheon.$PNAME.$PSITE en simpletest -y --strict=0
  - drush @pantheon.$PNAME.$PSITE vset -y simpletest_verbose 0 --strict=0
script:
  # Run real / additional tests here.
  #- drush @pantheon.$PNAME.$PSITE test-run MyTestClass --strict=0
after_script:
  #- drush psite-edelete $PUUID $PSITE -y
  - cd $TRAVIS_BUILD_DIR
  - git push pantheon :$PSITE